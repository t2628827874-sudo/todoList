# 闹钟功能排查指南

## 已完成的修复

### 1. 通知权限管理
- ✅ 添加了Android 13+的通知权限请求
- ✅ 在MainActivity中添加了权限检查和请求逻辑
- ✅ 添加了权限拒绝时的引导到设置页面

### 2. 闹钟设置优化
- ✅ 改进了闹钟设置的时机，使用同步查询而非异步观察
- ✅ 添加了详细的日志记录
- ✅ 添加了闹钟设置成功的提示

### 3. 通知增强
- ✅ 添加了系统默认通知声音
- ✅ 配置了闹钟音频类型（USAGE_ALARM）
- ✅ 添加了震动模式
- ✅ 设置了通知优先级为HIGH
- ✅ 添加了完整的错误处理和日志

### 4. WakeLock支持
- ✅ 在TodoReminderReceiver中添加了WakeLock
- ✅ 确保设备在后台唤醒
- ✅ 正确释放WakeLock避免内存泄漏

### 5. 设备重启恢复
- ✅ 创建了BootReceiver
- ✅ 设备重启后自动恢复所有未触发的闹钟
- ✅ 添加了RECEIVE_BOOT_COMPLETED权限

## 排查步骤

### 步骤1：检查通知权限

1. 打开应用
2. 如果弹出通知权限请求，点击"允许"
3. 如果没有弹出，进入系统设置：
   - 设置 > 应用 > Note > 通知
   - 确保"允许通知"已开启
   - 确保"待办事项提醒"通道的通知已开启

### 步骤2：检查闹钟权限（Android 12+）

1. 进入系统设置
2. 设置 > 应用 > Note > 特殊访问权限
3. 确保闹钟和提醒权限已开启

### 步骤3：测试通知功能

1. 打开应用
2. 应用启动2秒后会自动发送一个测试通知
3. 检查是否收到"测试通知"
4. 如果没有收到，说明通知权限或通知通道有问题

### 步骤4：设置一个测试闹钟

1. 点击右下角的"+"按钮
2. 输入待办事项标题
3. 勾选"添加提醒"
4. 选择"今天"
5. 设置时间为当前时间+1分钟
6. 点击"保存"
7. 观察是否显示"闹钟已设置: MM-dd HH:mm"的提示

### 步骤5：检查日志

如果闹钟不响，可以通过以下方式查看日志：

```bash
# 使用adb查看日志
adb logcat | grep -E "AlarmHelper|TodoReminderReceiver|NotificationHelper"
```

关键日志信息：
- `Alarm set successfully` - 闹钟设置成功
- `WakeLock acquired` - WakeLock获取成功
- `Notification shown` - 通知显示成功
- `Received reminder` - 收到闹钟触发

### 步骤6：检查系统设置

1. **检查通知音量**
   - 设置 > 声音和振动 > 通知音量
   - 确保音量不为0

2. **检查勿扰模式**
   - 确保勿扰模式未开启
   - 或者确保闹钟在勿扰模式中被允许

3. **检查应用电池优化**
   - 设置 > 应用 > Note > 电池
   - 选择"无限制"或"优化"

4. **检查后台运行权限**
   - 设置 > 应用 > Note > 允许后台活动
   - 确保已开启

## 常见问题

### Q1: 通知权限已授予，但仍然不响

**可能原因：**
- 通知通道被禁用
- 通知音量为0
- 勿扰模式开启

**解决方案：**
1. 进入设置 > 应用 > Note > 通知
2. 找到"待办事项提醒"通道
3. 确保通知、声音、震动都已开启
4. 检查通知音量设置

### Q2: 闹钟设置了，但到点不触发

**可能原因：**
- 闹钟权限未授予（Android 12+）
- 系统时间不正确
- 应用被系统杀死

**解决方案：**
1. 检查闹钟和提醒权限
2. 确保系统时间正确
3. 将应用加入白名单，防止被系统杀死

### Q3: 设备重启后闹钟丢失

**可能原因：**
- BootReceiver未正常工作
- RECEIVE_BOOT_COMPLETED权限未授予

**解决方案：**
1. 重启设备
2. 检查日志中是否有"Boot completed"和"Rescheduled X alarms"
3. 确保应用有RECEIVE_BOOT_COMPLETED权限

### Q4: 应用在后台时闹钟不响

**可能原因：**
- 应用被系统杀死
- 电池优化过于激进

**解决方案：**
1. 设置 > 应用 > Note > 电池 > 选择"无限制"
2. 设置 > 应用 > Note > 允许后台活动
3. 将应用加入系统白名单

## 调试技巧

### 1. 手动触发测试通知

在MainActivity中，应用启动2秒后会自动发送测试通知。

### 2. 查看已设置的闹钟

```bash
adb shell dumpsys alarm | grep com.example.note
```

### 3. 检查通知通道状态

```bash
adb shell cmd notification list channels com.example.note
```

### 4. 强制停止应用后重新启动

```bash
adb shell am force-stop com.example.note
adb shell am start -n com.example.note/.MainActivity
```

## 性能优化建议

1. **使用精确闹钟** - 确保使用setExactAndAllowWhileIdle
2. **合理使用WakeLock** - 及时释放WakeLock
3. **优化通知** - 使用合适的优先级和类别
4. **电池优化** - 避免频繁唤醒设备

## 总结

闹钟功能依赖于多个系统权限和设置，确保以下几点：

1. ✅ 通知权限已授予
2. ✅ 闹钟权限已授予（Android 12+）
3. ✅ 通知音量不为0
4. ✅ 勿扰模式未开启或闹钟被允许
5. ✅ 应用电池优化设置为"无限制"
6. ✅ 允许后台运行
7. ✅ 系统时间正确

如果以上都已确认但问题仍然存在，请查看日志获取更详细的错误信息。